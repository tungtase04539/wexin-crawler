{% extends "base.html" %}

{% block title %}Xuất dữ liệu - Hệ thống Quản lý WeChat{% endblock %}
{% block page_title %}Xuất dữ liệu{% endblock %}

{% block content %}
<div x-data="exportData()" x-init="loadAccounts()">

    <div class="max-w-2xl mx-auto">
        <!-- Export Form -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-6">Xuất bài viết</h2>

            <form @submit.prevent="exportArticles()">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Định dạng xuất</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="relative flex items-center p-4 border-2 rounded-lg cursor-pointer"
                            :class="exportConfig.format === 'json' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                            <input x-model="exportConfig.format" type="radio" value="json" class="sr-only">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-code text-2xl text-indigo-600"></i>
                                    <div>
                                        <p class="font-medium text-gray-900">JSON</p>
                                        <p class="text-xs text-gray-600">Định dạng dữ liệu cấu trúc</p>
                                    </div>
                                </div>
                            </div>
                            <i x-show="exportConfig.format === 'json'" class="fas fa-check-circle text-indigo-600"></i>
                        </label>

                        <label class="relative flex items-center p-4 border-2 rounded-lg cursor-pointer"
                            :class="exportConfig.format === 'csv' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'">
                            <input x-model="exportConfig.format" type="radio" value="csv" class="sr-only">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-table text-2xl text-green-600"></i>
                                    <div>
                                        <p class="font-medium text-gray-900">CSV</p>
                                        <p class="text-xs text-gray-600">Định dạng bảng tính (Excel)</p>
                                    </div>
                                </div>
                            </div>
                            <i x-show="exportConfig.format === 'csv'" class="fas fa-check-circle text-indigo-600"></i>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chọn tài khoản</label>
                    <select x-model="exportConfig.feed_id"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Tất cả tài khoản</option>
                        <template x-for="account in accountsList" :key="account.id">
                            <option :value="account.feed_id" x-text="account.name"></option>
                        </template>
                    </select>
                </div>

                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-indigo-600 mt-1"></i>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium mb-1">Thông tin xuất dữ liệu</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                <li>Dữ liệu xuất sẽ được lưu vào thư mục <code
                                        class="bg-white px-1 rounded">exports/</code></li>
                                <li>Quá trình xuất dữ liệu lớn có thể mất vài giây</li>
                                <li>Tên tệp được đặt kèm ngày tháng để dễ theo dõi</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <button type="submit" :disabled="exporting"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium disabled:opacity-50">
                    <span x-show="!exporting">
                        <i class="fas fa-download mr-2"></i>
                        Xuất bài viết
                    </span>
                    <span x-show="exporting">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Đang xuất...
                    </span>
                </button>
            </form>
        </div>

        <!-- Recent Exports -->
        <div x-show="lastExport" class="mt-6 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Lần xuất gần nhất</h3>
            <div class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-download text-green-600 text-2xl"></i>
                    <div>
                        <p class="font-medium text-gray-900" x-text="lastExport.filename"></p>
                        <p class="text-sm text-gray-600"><span x-text="lastExport.count"></span> bài viết</p>
                    </div>
                </div>
                <a :href="`/api/download/${lastExport.filename}`"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                    <i class="fas fa-download mr-2"></i>
                    Tải về
                </a>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function exportData() {
        return {
            accountsList: [],
            exportConfig: {
                format: 'json',
                feed_id: ''
            },
            exporting: false,
            lastExport: null,

            async loadAccounts() {
                try {
                    const response = await fetch('/api/accounts');
                    const data = await response.json();
                    if (data.success) {
                        this.accountsList = data.accounts;
                    }
                } catch (error) {
                    console.error('Failed to load accounts:', error);
                }
            },

            async exportArticles() {
                this.exporting = true;
                try {
                    const response = await fetch('/api/export', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.exportConfig)
                    });
                    const data = await response.json();

                    if (data.success) {
                        this.lastExport = data;
                        showToast(`Đã xuất ${data.count} bài viết thành công!`, 'success');
                    } else {
                        showToast(data.error || 'Xuất dữ liệu thất bại', 'error');
                    }
                } catch (error) {
                    showToast('Export failed', 'error');
                } finally {
                    this.exporting = false;
                }
            }
        }
    }
</script>
{% endblock %}